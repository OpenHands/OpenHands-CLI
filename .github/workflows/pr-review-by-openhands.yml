---
name: PR Review by OpenHands

on:
    # Security note:
    # - We intentionally run a tool-using reviewer agent on PRs (including forks).
    # - This workflow uses pull_request_target so we can access the LLM API key.
    # - Risk is reduced by:
    #   - minimal GITHUB_TOKEN permissions (no contents write, no actions)
    #   - disabling dependency/tool caches
    #   - running with an OpenHands pre_tool_use terminal guard hook
    #   - keeping secrets in-memory and removing them from env before tool use
    pull_request_target:
        types: [opened, ready_for_review, labeled, review_requested]

permissions:
    contents: read
    pull-requests: write

jobs:
    pr-review:
        if: |
            github.repository == 'OpenHands/OpenHands-CLI' && (
              (github.event.action == 'opened' && github.event.pull_request.draft == false) ||
              github.event.action == 'ready_for_review' ||
              github.event.label.name == 'review-this' ||
              github.event.requested_reviewer.login == 'openhands-agent' ||
              github.event.requested_reviewer.login == 'all-hands-bot'
            )
        concurrency:
            group: pr-review-${{ github.event.pull_request.number }}
            cancel-in-progress: true
        runs-on: ubuntu-24.04
        timeout-minutes: 25

        steps:
            - name: Checkout base repository (trusted)
              uses: actions/checkout@v5
              with:
                  fetch-depth: 0

            - name: Checkout PR repository (untrusted)
              uses: actions/checkout@v5
              with:
                  repository: ${{ github.event.pull_request.head.repo.full_name }}
                  ref: ${{ github.event.pull_request.head.sha }}
                  fetch-depth: 0
                  persist-credentials: false
                  path: pr-repo

            - name: Set up Python
              uses: actions/setup-python@v6
              with:
                  python-version: '3.12'

            - name: Install uv
              uses: astral-sh/setup-uv@v7
              with:
                  enable-cache: false

            - name: Install base dependencies
              run: uv sync --frozen --group dev

            - name: Run PR review agent
              env:
                  # Secrets are passed only to this trusted runner script and then
                  # removed from the environment before tool execution.
                  LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
                  LLM_BASE_URL: https://llm-proxy.app.all-hands.dev
                  LLM_MODEL: litellm_proxy/claude-sonnet-4-5-20250929
                  GITHUB_TOKEN: ${{ github.token }}
                  REPO_NAME: ${{ github.repository }}
                  PR_NUMBER: ${{ github.event.pull_request.number }}
                  PR_WORKSPACE: ${{ github.workspace }}/pr-repo
                  REVIEW_STYLE: roasted
              run: uv run python .github/scripts/pr_review_agent_runner.py
