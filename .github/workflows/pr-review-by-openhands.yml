---
name: PR Review by OpenHands

on:
    # Use pull_request_target to allow fork PRs to access secrets when triggered by maintainers
    # Security: This workflow runs when:
    #   1. A new PR is opened (non-draft), OR
    #   2. A draft PR is marked as ready for review, OR
    #   3. A maintainer adds the 'review-this' label, OR
    #   4. A maintainer requests openhands-agent or all-hands-bot as a reviewer
    # Only users with write access can add labels or request reviews, ensuring security.
    # The PR code is explicitly checked out for review, but secrets are only accessible
    # because the workflow runs in the base repository context
    pull_request_target:
        types: [opened, ready_for_review, labeled, review_requested]

permissions:
    contents: read
    pull-requests: write
    issues: write

jobs:
    pr-review:
        # Run when one of the following conditions is met:
        #   1. A new non-draft PR is opened by a trusted contributor, OR
        #   2. A draft PR is converted to ready for review by a trusted contributor, OR
        #   3. 'review-this' label is added, OR
        #   4. openhands-agent or all-hands-bot is requested as a reviewer
        # Note: FIRST_TIME_CONTRIBUTOR PRs require manual trigger via label/reviewer request
        if: |
            (github.event.action == 'opened' && github.event.pull_request.draft == false && github.event.pull_request.author_association != 'FIRST_TIME_CONTRIBUTOR') ||
            (github.event.action == 'ready_for_review' && github.event.pull_request.author_association != 'FIRST_TIME_CONTRIBUTOR') ||
            github.event.label.name == 'review-this' ||
            github.event.requested_reviewer.login == 'openhands-agent' ||
            github.event.requested_reviewer.login == 'all-hands-bot'
        concurrency:
            group: pr-review-${{ github.event.pull_request.number }}
            cancel-in-progress: true
        runs-on: ubuntu-24.04
        steps:
            # We avoid using the upstream composite action here because it enables
            # uv caching, and this workflow runs on untrusted fork PR content.
            # Disabling caches reduces the risk of cross-workflow cache poisoning.
            - name: Checkout software-agent-sdk repository
              uses: actions/checkout@v5
              with:
                  repository: OpenHands/software-agent-sdk
                  ref: main
                  path: software-agent-sdk

            - name: Checkout PR repository
              uses: actions/checkout@v5
              with:
                  repository: ${{ github.event.pull_request.head.repo.full_name }}
                  ref: ${{ github.event.pull_request.head.ref }}
                  fetch-depth: 0
                  persist-credentials: false
                  path: pr-repo

            - name: Set up Python
              uses: actions/setup-python@v6
              with:
                  python-version: '3.12'

            - name: Install uv
              uses: astral-sh/setup-uv@v6
              with:
                  # Security: this workflow processes untrusted PR text/diffs.
                  # Disable uv caching to reduce cross-workflow cache poisoning risk.
                  enable-cache: false

            - name: Install GitHub CLI
              shell: bash
              run: |
                  sudo apt-get update
                  sudo apt-get install -y gh

            - name: Install OpenHands dependencies
              shell: bash
              run: |
                  uv pip install --system ./software-agent-sdk/openhands-sdk ./software-agent-sdk/openhands-tools lmnr

            - name: Run PR review
              shell: bash
              env:
                  LLM_MODEL: litellm_proxy/claude-sonnet-4-5-20250929
                  LLM_BASE_URL: https://llm-proxy.app.all-hands.dev
                  REVIEW_STYLE: roasted
                  LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
                  GITHUB_TOKEN: ${{ secrets.ALLHANDS_BOT_GITHUB_PAT }}
                  LMNR_PROJECT_API_KEY: ${{ secrets.LMNR_SKILLS_API_KEY }}
                  PR_NUMBER: ${{ github.event.pull_request.number }}
                  PR_TITLE: ${{ github.event.pull_request.title }}
                  PR_BODY: ${{ github.event.pull_request.body }}
                  PR_BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
                  PR_HEAD_BRANCH: ${{ github.event.pull_request.head.ref }}
                  REPO_NAME: ${{ github.repository }}
              run: |
                  cd pr-repo
                  python ../software-agent-sdk/examples/03_github_workflows/02_pr_review/agent_script.py
