---
# Workflow that builds and tests the CLI binary executable
name: CLI - Build binary and optionally release

# Run on pushes to main branch and CLI tags, and on pull requests when CLI files change
on:
    push:
        branches: [main]
        tags:
            - '*'
    pull_request:
        branches: ['**']

permissions:
    contents: write     # needed to create releases or upload assets

# Cancel previous runs if a new commit is pushed
concurrency:
    group: ${{ github.workflow }}-${{ (github.head_ref && github.ref) || github.run_id }}
    cancel-in-progress: true

jobs:
    build-binary:
        name: Build binary executable
        strategy:
            matrix:
                include:
          # Build on Ubuntu 22.04 for maximum GLIBC compatibility (GLIBC 2.31)
                    - os: ubuntu-22.04
                      platform: linux
                      artifact_name: openhands-cli-linux
          # Build on macOS for macOS users
                    - os: macos-15
                      platform: macos
                      artifact_name: openhands-cli-macos
          # Build on Windows 2025 for Windows users
                    - os: windows-2025
                      platform: windows
                      artifact_name: openhands-cli-windows
        runs-on: ${{ matrix.os }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            # Windows-specific: Set up WSL
            - name: Set up WSL (Windows only)
              if: matrix.platform == 'windows'
              uses: Vampire/setup-wsl@v3
              with:
                  distribution: Ubuntu-22.04
                  additional-packages:
                      python3
                      python3-pip
                      python3-venv
                      build-essential
                      curl

            # Non-Windows: Set up Python normally
            - name: Set up Python (Non-Windows)
              if: matrix.platform != 'windows'
              uses: actions/setup-python@v5
              with:
                  python-version: 3.12

            # Non-Windows: Install uv normally
            - name: Install uv (Non-Windows)
              if: matrix.platform != 'windows'
              uses: astral-sh/setup-uv@v3
              with:
                  version: latest

            # Windows WSL: Install uv in WSL
            - name: Install uv (Windows WSL)
              if: matrix.platform == 'windows'
              shell: wsl-bash {0}
              run: |
                  curl -LsSf https://astral.sh/uv/install.sh | sh
                  echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> ~/.bashrc
                  source ~/.bashrc

            # Non-Windows: Install dependencies normally
            - name: Install dependencies (Non-Windows)
              if: matrix.platform != 'windows'
              run: |
                  uv sync

            # Windows WSL: Install dependencies in WSL
            - name: Install dependencies (Windows WSL)
              if: matrix.platform == 'windows'
              shell: wsl-bash {0}
              run: |
                  source ~/.bashrc
                  uv sync

            # Non-Windows: Build normally
            - name: Build binary executable (Non-Windows)
              if: matrix.platform != 'windows'
              run: |
                  ./build.sh --install-pyinstaller | tee output.log
                  echo "Full output:"
                  cat output.log

                  if grep -q "❌" output.log; then
                    echo "❌ Found failure marker in output"
                    exit 1
                  fi

                  echo "✅ Build & test finished without ❌ markers"
              shell: bash

            # Windows WSL: Build in WSL
            - name: Build binary executable (Windows WSL)
              if: matrix.platform == 'windows'
              shell: wsl-bash {0}
              run: |
                  source ~/.bashrc
                  ./build.sh --install-pyinstaller | tee output.log
                  echo "Full output:"
                  cat output.log

                  if grep -q "❌" output.log; then
                    echo "❌ Found failure marker in output"
                    exit 1
                  fi

                  echo "✅ Build & test finished without ❌ markers"

            # Non-Windows: Verify binary files exist normally
            - name: Verify binary files exist (Non-Windows)
              if: matrix.platform != 'windows'
              run: |
                  if ! ls dist/openhands* 1> /dev/null 2>&1; then
                    echo "❌ No binaries found to upload!"
                    exit 1
                  fi
                  echo "✅ Found binaries to upload."

            # Windows WSL: Verify binary files exist in WSL
            - name: Verify binary files exist (Windows WSL)
              if: matrix.platform == 'windows'
              shell: wsl-bash {0}
              run: |
                  if ! ls dist/openhands* 1> /dev/null 2>&1; then
                    echo "❌ No binaries found to upload!"
                    exit 1
                  fi
                  echo "✅ Found binaries to upload."

            - name: Upload binary artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.artifact_name }}
                  path: dist/openhands*
                  retention-days: 30

    create-github-release:
        name: Create GitHub Release
        runs-on: blacksmith-2vcpu-ubuntu-2404
        needs: build-binary
        if: startsWith(github.ref, 'refs/tags/')
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: Prepare release assets
              run: |
                  mkdir -p release-assets
                  # Copy binaries with appropriate names for release
                  if [ -f artifacts/openhands-cli-linux/openhands ]; then
                    cp artifacts/openhands-cli-linux/openhands release-assets/openhands-linux
                  fi
                  if [ -f artifacts/openhands-cli-macos/openhands ]; then
                    cp artifacts/openhands-cli-macos/openhands release-assets/openhands-macos
                  fi
                  if [ -f artifacts/openhands-cli-windows/openhands.exe ]; then
                    cp artifacts/openhands-cli-windows/openhands.exe release-assets/openhands-windows.exe
                  fi
                  ls -la release-assets/

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  files: release-assets/*
                  draft: true
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
